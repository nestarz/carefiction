import{options,createContext,createElement,isValidElement,cloneElement}from"preact";var t,u,r,i=0,o=[],c=options.__r,f=options.diffed,e=options.__c,a=options.unmount;function v(t,e){options.__h&&options.__h(u,t,i||e),i=0;var n=u.__H||(u.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function m(t){return i=1,p(E,t)}function p(e,n,o){var r=v(t++,2);return r.__c||(r.__c=u,r.__=[o?o(n):E(void 0,n),function(t){var n=e(r.__[0],t);r.__[0]!==n&&(r.__[0]=n,r.__c.setState({}))}]),r.__}function l(e,n){var o=v(t++,3);!options.__s&&x(o.__H,n)&&(o.__=e,o.__H=n,u.__H.__h.push(o))}function y(e,n){var o=v(t++,4);!options.__s&&x(o.__H,n)&&(o.__=e,o.__H=n,u.__h.push(o))}function d(t){return i=5,h(function(){return{current:t}},[])}function h(e,n){var o=v(t++,7);return x(o.__H,n)?(o.__H=n,o.__h=e,o.__=e()):o.__}function T(t,e){return i=8,h(function(){return t},e)}function w(e){var n=u.context[e.__c],o=v(t++,9);return o.__c=e,n?(null==o.__&&(o.__=!0,n.sub(u)),n.props.value):e.__}function _(){o.some(function(t){if(t.__P)try{t.__H.__h.forEach(g),t.__H.__h.forEach(q),t.__H.__h=[]}catch(e){return t.__H.__h=[],options.__e(e,t.__v),!0}}),o=[]}function g(t){t.t&&t.t()}function q(t){var e=t.__();"function"==typeof e&&(t.t=e)}function x(t,e){return!t||e.some(function(e,n){return e!==t[n]})}function E(t,e){return"function"==typeof e?e(t):e}options.__r=function(e){c&&c(e),t=0,(u=e.__c).__H&&(u.__H.__h.forEach(g),u.__H.__h.forEach(q),u.__H.__h=[])},options.diffed=function(t){f&&f(t);var e=t.__c;if(e){var n=e.__H;n&&n.__h.length&&(1!==o.push(e)&&r===options.requestAnimationFrame||((r=options.requestAnimationFrame)||function(t){var e,n=function(){clearTimeout(o),cancelAnimationFrame(e),setTimeout(t)},o=setTimeout(n,100);"undefined"!=typeof window&&(e=requestAnimationFrame(n))})(_))}},options.__c=function(t,n){n.some(function(t){try{t.__h.forEach(g),t.__h=t.__h.filter(function(t){return!t.__||q(t)})}catch(e){n.some(function(t){t.__h&&(t.__h=[])}),n=[],options.__e(e,t.__v)}}),e&&e(t,n)},options.unmount=function(t){a&&a(t);var e=t.__c;if(e){var n=e.__H;if(n)try{n.__.forEach(function(t){return t.t&&t.t()})}catch(t){options.__e(t,e.__v)}}};var locationHook=({base:t=""}={})=>{const[e,n]=m(currentPathname(t)),o=d(e);return l(()=>{patchHistoryEvents();const e=()=>{const e=currentPathname(t);o.current!==e&&n(o.current=e)},r=["popstate","pushState","replaceState"];return r.map(t=>addEventListener(t,e)),e(),()=>r.map(t=>removeEventListener(t,e))},[]),[e,T((e,n)=>history[n?"replaceState":"pushState"](0,0,t+e),[])]};let patched=0;const patchHistoryEvents=()=>{if(!patched)return["pushState","replaceState"].map(t=>{const e=history[t];history[t]=function(){const n=e.apply(this,arguments),o=new Event(t);return o.arguments=arguments,dispatchEvent(o),n}}),patched=1},currentPathname=(t,e=location.pathname)=>e.indexOf(t)?e:e.slice(t.length)||"/";function makeMatcher(t=pathToRegexp){let e={};return(n,o)=>{const{regexp:r,keys:u}=(n=>e[n]||(e[n]=t(n)))(n||""),_=r.exec(o);return _?[!0,u.reduce((t,e,n)=>(t[e.name]=_[n+1],t),{})]:[!1,null]}}const escapeRx=t=>t.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1"),rxForSegment=(t,e,n)=>{let o=t?"((?:[^\\/]+?)(?:\\/(?:[^\\/]+?))*)":"([^\\/]+?)";return e&&n&&(o="(?:\\/"+o+")"),o+(e?"?":"")},pathToRegexp=t=>{const e=/:([A-Za-z0-9_]+)([?+*]?)/g;let n=null,o=0,r=[],u="";for(;null!==(n=e.exec(t));){const[_,c,i]=n,a="+"===i||"*"===i,s="?"===i||"*"===i,h=s&&"/"===t[n.index-1]?1:0,p=t.substring(o,n.index-h);r.push({name:c}),o=e.lastIndex,u+=escapeRx(p)+rxForSegment(a,s,h)}return u+=escapeRx(t.substring(o)),{keys:r,regexp:new RegExp("^"+u+"(?:\\/)?$","i")}},RouterCtx=createContext({}),buildRouter=({hook:t=locationHook,base:e="",matcher:n=makeMatcher()}={})=>({hook:t,base:e,matcher:n}),useRouter=()=>{const t=w(RouterCtx);return t.v||(t.v=buildRouter())},useLocation=()=>{const t=useRouter();return t.hook(t)},useRoute=t=>{const[e]=useLocation();return useRouter().matcher(t,e)},Router=t=>{const e=d(null),n=e.current||(e.current={v:buildRouter(t)});return createElement(RouterCtx.Provider,{value:n,children:t.children})},Route=({path:t,match:e,component:n,children:o})=>{const r=useRoute(t),[u,_]=e||r;return u?n?createElement(n,{params:_}):"function"==typeof o?o(_):o:null},Link=t=>{const[,e]=useLocation(),{base:n}=useRouter(),o=t.href||t.to,{children:r,onClick:u}=t,_=T(t=>{t.ctrlKey||t.metaKey||t.altKey||t.shiftKey||0!==t.button||(t.preventDefault(),e(o),u&&u(t))},[o,u,e]),c={href:n+o,onClick:_,to:null},i=isValidElement(r)?r:createElement("a",t);return cloneElement(i,c)},Switch=({children:t,location:e})=>{const{matcher:n}=useRouter(),[o]=useLocation();t=Array.isArray(t)?t:[t];for(const r of t){let t=0;if(isValidElement(r)&&r.props.path&&(t=n(r.props.path,e||o))[0])return cloneElement(r,{match:t})}return null},Redirect=t=>{const[,e]=useLocation();return y(()=>{e(t.href||t.to)},[]),null};export default useRoute;export{Link,Redirect,Route,Router,Switch,useLocation,useRoute,useRouter};