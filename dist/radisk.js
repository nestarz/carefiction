!function(){function m(e){(e=e||{}).log=e.log||console.log,e.file=String(e.file||"radata");var B=(m.has||(m.has={}))[e.file];if(B)return B;function t(h){return encodeURIComponent(h).replace(/\*/g,"%2A")}e.pack=e.pack||.3*(e.memory?1000*e.memory*1000:1.399e09),e.until=e.until||e.wait||250,e.batch=e.batch||10000,e.chunk=e.chunk||1048576,e.code=e.code||{},e.code.from=e.code.from||"!",e.jsonify=!0;var y="undefined"==typeof setImmediate?setTimeout:setImmediate,w=setTimeout.puff||y,x=(u.obj.map,u.obj.empty),z=0;if(!e.store)return e.log("ERROR: Radisk needs `opt.store` interface with `{get: fn, put: fn (, list: fn)}`!");if(!e.store.put)return e.log("ERROR: Radisk needs `store.put` interface with `(file, data, cb)`!");if(!e.store.get)return e.log("ERROR: Radisk needs `store.get` interface with `(file, cb)`!");e.store.list;var i=function(h,l,d,k,b){if("function"==typeof l){var c=d||{};return d=l,void i.read(h,d,c,b||k)}i.save(h,l,d,k,b)};i.save=function(h,l,d,k,b){var c,j,a={key:h};a.find=function(f){var g;a.file=f||(f=e.code.from),b&&(b=b[f]=b[f]||{}),b&&(b.sf=b.sf||+new Date()),(g=i.disk[f])?a.mix(s,g):i.parse(f,a.mix,s,b)},a.mix=function(f,g){if(b&&(b.sml=+new Date()),b&&(b.sm=b.sm||+new Date()),a.err=f||a.err)d(f);else{var o,n=a.file=(g||"").file||a.file;if(!g&&n!==e.code.from)return i.find.bad(n),void i.save(h,l,d,k);(g=i.disk[n]||(i.disk[n]=g||q())).file||(g.file=n),e.compare&&(l=e.compare(g(h),l,h,n),s===l)?d(f,-1):((a.disk=g)(h,l),k&&((o=(o=g.tags||(g.tags={}))[k]||(o[k]=i.tags[k]||(i.tags[k]={})))[n]||(o[n]=i.one[k]||(i.one[k]=d)),d=null),b&&(b.st=b.st||+new Date()),g.Q?d&&g.Q.push(d):(g.Q=d?[d]:[],g.to=setTimeout(a.write,e.until)))}},a.write=function(){b&&(b.sto=b.sto||+new Date());var f=c=a.file,g=a.disk;j=a.q=g.Q,a.tags=g.tags,delete g.Q,delete i.disk[f],delete g.tags,i.write(f,g,a.ack,s,b)},a.ack=function(f,g){var o,n;for(var p in(b&&(b.sa=b.sa||+new Date()),b&&(b.sal=j.length),i.tags))if(i.tags.hasOwnProperty(p)){var r=i.tags[p];(n=i.disk[c])&&(n=n.tags)&&n[r]||(o=r[c],delete r[c],x(r)&&(delete i.tags[r],o&&o(f,g)))}!j&&(j="");for(var A=j.length,D=0,E=+new Date();D<A;D++)(o=j[D])&&o(f,g);console.STAT&&console.STAT(E,+new Date()-E,"rad acks",t(a.file)),console.STAT&&console.STAT(E,j.length,"rad acks #",t(a.file))},d||(d=function(f,g){}),i.find(h,a.find)},i.disk={},i.one={},i.tags={};var J,C,K,Q=0;i.write=function(h,l,d,k,b){if(l){k="object"==typeof k?k:{force:k};var c,j,a=function(){};a.text="",a.file=h=l.file||(l.file=h),h?(a.write=function(){var f=l.raw=a.text;i.disk[h=l.file||a.file||h]=l;var g=+new Date();b&&(b.wd=g),i.find.add(h,function(o){b&&(b.wa=+new Date()),o?d(o):e.store.put(t(h),f,function(n,p){b&&(b.wp=+new Date()),console.STAT&&console.STAT(g,z=+new Date()-g,"wrote disk",JSON.stringify(h),++Q,"total all writes."),d(n,p||1),l.Q||delete i.disk[h]})})},a.split=function(){var f=+new Date();b&&(b.wf=f),a.text="",a.count||(a.count=0,q.map(l,function(){a.count++})),b&&(b.wfc=a.count),a.limit=Math.ceil(a.count/2);var g=a.count;return a.count=0,b&&(b.wf1=+new Date()),a.sub=q(),q.map(l,a.slice,{reverse:1}),b&&(b.wf2=+new Date()),i.write(a.end,a.sub,a.both,k),b&&(b.wf3=+new Date()),a.hub=q(),q.map(l,a.stop),b&&(b.wf4=+new Date()),i.write(l.file,a.hub,a.both,k),b&&(b.wf5=+new Date()),console.STAT&&console.STAT(f,+new Date()-f,"rad split",t(l.file),g),!0},a.slice=function(f,g){if(a.sub(a.end=g,f),a.limit<=++a.count)return!0},a.stop=function(f,g){if(g>=a.end)return!0;a.hub(g,f)},a.both=function(f,g){b&&(b.wfd=+new Date()),j?d(f||j):c?d(f,g):(c=!0,j=f)},a.each=function(f,g,o,n){if(s!==f&&a.count++,e.pack<=(f||"").length)return d("Data too big!"),!0;var p=m.encode(n.length)+"#"+m.encode(o)+(s===f?"":":"+m.encode(f))+`
`;if(e.chunk<a.text.length+p.length&&1<a.count&&!k.force)return a.split();a.text+=p},e.jsonify?i.write.jsonify(a,l,d,k,b):q.map(l,a.each,!0)||a.write()):d("What file?")}else d("No radix!")},i.write.jsonify=function(h,l,d,k,b){var c,j=+new Date();b&&(b.w=j);try{c=JSON.stringify(l.$)}catch(f){return void d("Cannot radisk!")}if(b&&(b.ws=+new Date()),console.STAT&&console.STAT(j,+new Date()-j,"rad stringified JSON"),e.chunk<c.length&&!k.force){var a=0;if(q.map(l,function(){if(a++)return!0}),a>1)return h.split()}h.text=c,h.write()},i.range=function(h,l){if(h&&l){if(s===l.start&&s===l.end)return h;if(s!==(d=h)&&(!d||"object"!=typeof d))return h;var d,k=q();return q.map(h,function(b,c){k(c,b)},l),k("")}},function(){i.read=function(h,l,d,k){d=d||{};var b={key:h,find:function(c){var j;b.file=c||(c=e.code.from),k&&(k=k[c]=k[c]||{}),k&&(k.rf=k.rf||+new Date()),(j=i.disk[b.file=c])?b.check(s,j):i.parse(c,b.check,s,k)},get:function(c,j,a){if(k&&(k.rgl=+new Date()),k&&(k.rg=k.rg||+new Date()),b.err=c||b.err)l(c);else{var f=b.file=(j||"").file||b.file;if(!j&&f!==e.code.from)return i.find.bad(f),void i.read(h,l,d);if(j=i.disk[f]||(i.disk[f]=j)){j.file||(j.file=f);var g=i.range(j(h),d);if(k&&(k.rr=+new Date()),d.unit=j.unit,d.chunks=(d.chunks||0)+1,d.parsed=(d.parsed||0)+((a||"").parsed||d.chunks*e.chunk),d.more=1,d.next=s,q.map(i.list,function(p,r){if(p&&f!==r)return d.next=r,1},d.reverse?{reverse:1,end:f}:{start:f}),k&&(k.rl=+new Date()),d.next||(d.more=0),d.next&&((!d.reverse&&h<d.next&&0!=d.next.indexOf(h)||s!==d.end&&(d.end||"ï¿¿")<d.next)&&(d.more=0),(d.reverse&&h>d.next&&0!=h.indexOf(d.next)||s!==d.start&&(d.start||"")>d.next)&&(d.more=0)),d.more){if(g&&l(b.err,g,d),!(d.parsed>=d.limit)){var o=+new Date();k&&(k.rm=o);var n=d.next;y(function(){console.STAT&&console.STAT(o,+new Date()-o,"rad more"),i.parse(n,b.check)},0)}}else l(b.err,g,d)}else l(f===e.code.from?s:"No file!")}},check:function(c,j,a){if(b.get(c,j,a),j&&!j.check){j.check=1;var f=+new Date();(a||(a={})).file||(a.file=b.file),q.map(j,function(g,o){i.find(o,function(n){if((n||(n=e.code.from))!==a.file){var p=u.text.random(3);w(function(){i.save(o,g,function r(A,D){A?i.save(o,g,r):console.STAT&&console.STAT("MISLOCATED DATA CORRECTED",p,t(o),t(a.file),t(n))})},0)}})}),console.STAT&&console.STAT(f,+new Date()-f,"rad check")}}};i.find(h,b.find)}}(),J=0,C={},K=String.fromCharCode(31),i.parse=function(h,l,d,k){var b;if(!h)return l();if(b=C[h])b.push(l);else{b=C[h]=[l];var c=function(){},j={file:h};(c.disk=q()).file=h,c.read=function(f,g){var o;if(k&&(k.rpg=+new Date()),console.STAT&&console.STAT(a,+new Date()-a,"read disk",JSON.stringify(h),++J,"total all parses."),delete C[h],(c.err=f)||(c.not=!g))c.map(b,c.ack);else{if("string"!=typeof g){try{e.pack<=g.length?c.err="Chunk too big!":g=g.toString()}catch(p){c.err=p}if(c.err)return void c.map(b,c.ack)}if(j.parsed=g.length,k&&(k.rpl=j.parsed),k&&(k.rpa=b.length),a=+new Date(),e.jsonify||"{"===g[0]){try{var n=JSON.parse(g);return c.disk.$=n,console.STAT&&(z=+new Date()-a)>9&&console.STAT(a,z,"rad parsed JSON"),k&&(k.rpd=+new Date()),void c.map(b,c.ack)}catch(p){o=p}if("{"===g[0])return c.err=o||"JSON error!",void c.map(b,c.ack)}c.radec(f,g)}},c.map=function(){if(b&&b.length){for(var f,g=+new Date(),o=c.err,n=c.not?s:c.disk,p=0;p<9&&(f=b[p++]);)f(o,n,j);console.STAT&&console.STAT(g,+new Date()-g,"rad packs",t(h)),console.STAT&&console.STAT(g,p,"rad packs #",t(h)),(b=b.slice(p)).length&&w(c.map,0)}},c.ack=function(f){f&&(c.err||c.not?f(c.err,s,j):f(s,c.disk,j))},c.radec=function(f,g){a=+new Date();var o,n,p,r=c.split(g),A=[];if(!r||0!==r[1])return c.err="File '"+h+"' does not have root radix! ",void c.map(b,c.ack);for(;r;)n=p=s,o=r[1],"#"==(r=c.split(r[2])||"")[0]&&(n=r[1],o<=(A=A.slice(0,o)).length&&A.push(n)),`
`!=(r=c.split(r[2])||"")[0]&&("="!=r[0]&&":"!=r[0]||(p=r[1]),s!==n&&s!==p&&c.disk(A.join(""),p),r=c.split(r[2]));console.STAT&&console.STAT(a,+new Date()-a,"parsed RAD"),c.map(b,c.ack)},c.split=function(f){if(f){var g,o,n=[],p={};if(g=f.indexOf(K),f[g])return o=f.slice(0,g),n[0]=o,n[1]=m.decode(f.slice(g),p),n[2]=f.slice(g+p.i),n}},i.disk&&(d||(d=(i.disk[h]||"").raw));var a=+new Date();if(k&&(k.rp=a),d)return w(function(){c.read(s,d)},0);e.store.get(t(h),c.read)}},function(){var h,l,d=String.fromCharCode(28);function k(c,j){if(c)return e.log("list",c),void setTimeout(function(){i.parse(d,k)},1000);j?b(j):(h=h||j||q(),e.store.list?e.store.list(function(a){a?i.find.add(a,L):b(h)}):b(h))}function b(c,j){(h=h||c).file=d,j=l,l=null,u.list.map(j,function(a){i.find(a[0],a[1])})}i.find=function(c,j){if(!h)return l?void l.push([c,j]):(l=[[c,j]],void i.parse(d,k));q.map(i.list=h,function(a,f){if(a)return j(f)||!0},{reverse:1,end:c})||j(e.code.from)},i.find.add=function(c,j){h(c)||c===d?j(s,1):(h(c,1),j.found=(j.found||0)+1,i.write(d,h,function(a,f){a?j(a):(j.found=(j.found||0)-1,0===j.found&&j(s,1))},!0))},i.find.bad=function(c,j){h(c,0),i.write(d,h,j||L)}}();try{!u.window&&require("./radmigtmp")(i)}catch(h){}var s,L=function(){};return m.has[e.file]=i,i}var v;if(v=String.fromCharCode(31),m.encode=function(e,B,t){var y,w=t=t||v;if("string"==typeof e){for(var x=e.indexOf(t);-1!=x;)w+=t,x=e.indexOf(t,x+1);return w+'"'+e+t}return e&&e["#"]&&(y=u.val.link.is(e))?w+"#"+y+w:u.num.is(e)?w+"+"+(e||0)+w:null===e?w+" "+w:!0===e?w+"+"+w:!1===e?w+"-"+w:void 0},m.decode=function(e,B,t){var y,w,x,z=-1,i=0;if((t=t||v)===e[0]){for(;t===e[++z];)++i;for(x=e[w=i]||!0;--i>=0;)z=e.indexOf(t,z+1);return-1==z&&(z=e.length),y=e.slice(w+1,z),B&&(B.i=z+1),'"'===x?y:"#"===x?u.val.link.ify(y):"+"===x?0===y.length||parseFloat(y):" "===x?null:"-"!==x&&void 0}},"undefined"!=typeof window){var u=window.Gun,q=window.Radix;window.Radisk=m}else{u=require("../gun"),q=require("./radix");try{module.exports=m}catch(e){}}m.Radix=q}();
