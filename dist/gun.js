!function(){function x(F,b){return b?require(F):F.slice?x[p(F)]:function(k,m){F(k={exports:{}}),x[p(m)]=k.exports};function p(k){return k.split("/").slice(-1).toString().replace(".js","")}}if("undefined"!=typeof module)var O=module;x(function(F){var b={fn:{is:function(e){return!!e&&"function"==typeof e}}};b.bi={is:function(e){return e instanceof Boolean||"boolean"==typeof e}},b.num={is:function(e){return!p(e)&&(e-parseFloat(e)+1>=0||1/0===e||-1/0===e)}},b.text={is:function(e){return"string"==typeof e}},b.text.ify=function(e){return b.text.is(e)?e:"undefined"!=typeof JSON?JSON.stringify(e):e&&e.toString?e.toString():e},b.text.random=function(e,s){var t="";for(e=e||24,s=s||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e>0;)t+=s.charAt(Math.floor(Math.random()*s.length)),e--;return t},b.text.match=function(e,s){var t,h;return"string"==typeof e&&("string"==typeof s&&(s={"=":s}),e===(t=(s=s||{})["="]||s["*"]||s[">"]||s["<"])||h===s["="]&&(t=s["*"]||s[">"]||s["<"],e.slice(0,(t||"").length)===t||h===s["*"]&&(h!==s[">"]&&h!==s["<"]?e>=s[">"]&&e<=s["<"]:h!==s[">"]&&e>=s[">"]||h!==s["<"]&&e<=s["<"])))},b.text.hash=function(e,s){if("string"==typeof e){if(s=s||0,!e.length)return s;for(var t=0,h=e.length;t<h;++t)s=(s<<5)-s+e.charCodeAt(t),s|=0;return s}},b.list={is:function(e){return e instanceof Array}},b.list.slit=Array.prototype.slice,b.list.sort=function(e){return function(s,t){return s&&t?(s=s[e])<(t=t[e])?-1:s>t?1:0:0}},b.list.map=function(e,s,t){return y(e,s,t)},b.list.index=1,b.obj={is:function(e){return!!e&&(e instanceof Object&&e.constructor===Object||"Object"===Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1])}},b.obj.put=function(e,s,t){return(e||{})[s]=t,e},b.obj.has=function(e,s){return e&&Object.prototype.hasOwnProperty.call(e,s)},b.obj.del=function(e,s){if(e)return e[s]=null,delete e[s],e},b.obj.as=function(e,s,t,h){return e[s]=e[s]||(h===t?{}:t)},b.obj.ify=function(e){if(m(e))return e;try{e=JSON.parse(e)}catch(s){e={}}return e},function(){var e;function s(t,h){u(this,h)&&e!==this[h]||(this[h]=t)}b.obj.to=function(t,h){return y(t,s,h=h||{}),h}}(),b.obj.copy=function(e){return e?JSON.parse(JSON.stringify(e)):e},function(){function e(s,t){var h=this.n;if(!h||!(t===h||m(h)&&u(h,t)))return void 0!==t||void 0}b.obj.empty=function(s,t){return!s||!y(s,e,{n:t})}}(),function(){function e(h,i){if(2===arguments.length)return e.r=e.r||{},void(e.r[h]=i);e.r=e.r||[],e.r.push(h)}var s,t=Object.keys;Object.keys=Object.keys||function(h){return s(h,function(i,l,o){o(l)})},b.obj.map=s=function(h,i,l){var o,q,A,z,f,c=0,a="function"==typeof i;if(e.r=o,t&&m(h)&&(z=t(h),f=!0),l=l||{},p(h)||z)for(q=(z||h).length;c<q;c++){var n=c+b.list.index;if(a){if((A=f?i.call(l,h[z[c]],z[c],e):i.call(l,h[c],n,e))!==o)return A}else if(i===h[f?z[c]:c])return z?z[c]:n}else for(c in h)if(a){if(u(h,c)&&(A=l?i.call(l,h[c],c,e):i(h[c],c,e))!==o)return A}else if(i===h[c])return c;return a?e.r:b.list.index?0:-1}}(),b.time={},b.time.is=function(e){return e?e instanceof Date:+new Date().getTime()},b.fn.is;var p=b.list.is,k=b.obj,m=k.is,u=k.has,y=k.map;F.exports=b})(x,"./type"),x(function(F){F.exports=function b(p,k,m){if(!p)return{to:b};p=(this.tag||(this.tag={}))[p]||(this.tag[p]={tag:p,to:b._={next:function(y){var e;(e=this.to)&&e.next(y)}}});if("function"==typeof k){var u={off:b.off||(b.off=function(){if(this.next===b._.next)return!0;this===this.the.last&&(this.the.last=this.back),this.to.back=this.back,this.next=b._.next,this.back.to=this.to,this.the.last===this.the&&delete this.on.tag[this.the.tag]}),to:b._,next:k,the:p,on:this,as:m};return(u.back=p.last||p).to=u,p.last=u}return(p=p.to)&&void 0!==k&&p.next(k),p}})(x,"./onto"),x(function(F){var b="undefined"!=typeof setImmediate?setImmediate:setTimeout,p=[];F.exports=setTimeout.puff=function(k){p.length?p.push(k):(p=[k],b(function m(u){u=u||+new Date();for(var y,e=0;e<9&&(y=p[e++]);)y();if(console.STAT&&console.STAT(u,+new Date()-u,"puff"),y&&!(+new Date()-u))return m(u);(p=p.slice(e)).length&&b(m,0)},0))}})(x,"./puff"),x(function(F){if("undefined"==typeof JSON)throw new Error("JSON is not included in this browser. Please load it first: ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js");var b=JSON.stringify;F.exports=function(p,k,m,u,y){if(p<k)return{defer:!0};if(k<m)return{historical:!0};if(m<k)return{converge:!0,incoming:!0};if(k===m){if((u=b(u)||"")===(y=b(y)||""))return{state:!0};if(u<y)return{converge:!0,current:!0};if(y<u)return{converge:!0,incoming:!0}}return{err:"Invalid CRDT Data: "+u+" to "+y+" at "+k+" to "+m+"!"}}})(x,"./HAM"),x(function(F){var b=x("./type"),p={is:function(i){return void 0!==i&&(null===i||i!==1/0&&(!!(y(i)||m(i)||u(i))||(p.link.is(i)||!1)))}};p.link=p.rel={_:"#"},function(){function i(l,o){var q=this;return q.id?q.id=!1:o==k&&y(l)?void(q.id=l):q.id=!1}p.link.is=function(l){if(l&&l[k]&&!l._&&s(l)){var o={};if(h(l,i,o),o.id)return o.id}return!1}}(),p.link.ify=function(i){return t({},k,i)},b.obj.has._=".";var k=p.link._,m=b.bi.is,u=b.num.is,y=b.text.is,e=b.obj,s=e.is,t=e.put,h=e.map;F.exports=p})(x,"./val"),x(function(F){var b=x("./type"),p=x("./val"),k={_:"_",soul:function(h,i){return h&&h._&&h._[i||t]}};k.soul.ify=function(h,i){return i="string"==typeof i?{soul:i}:i||{},(h=h||{})._=h._||{},h._[t]=i.soul||h._[t]||s(),h},k.soul._=p.link._,function(){function h(i,l){if(l!==k._)return!p.is(i)||void(this.cb&&this.cb.call(this.as,i,l,this.n,this.s))}k.is=function(i,l,o){var q;return!!u(i)&&(!!(q=k.soul(i))&&!e(i,h,{as:o,cb:l,s:q,n:i}))}}(),function(){function h(i,l){var o,q=this.o;q.map?void 0===(o=q.map.call(this.as,i,""+l,q.node))?y(q.node,l):q.node&&(q.node[l]=o):p.is(i)&&(q.node[l]=i)}k.ify=function(i,l,o){return l?"string"==typeof l?l={soul:l}:"function"==typeof l&&(l={map:l}):l={},l.map&&(l.node=l.map.call(o,i,void 0,l.node||{})),(l.node=k.soul.ify(l.node||{},l))&&e(i,h,{o:l,as:o}),l.node}}();var m=b.obj,u=m.is,y=m.del,e=m.map,s=b.text.random,t=k.soul._;F.exports=k})(x,"./node"),x(function(F){var b=x("./type"),p=x("./node");function k(){var a;return a=+new Date(),m<a?(u=0,m=a+k.drift):m=a+(u+=1)/y+k.drift}b.time.is;var m=-1/0,u=0,y=1000,e="undefined"!=typeof performance&&(performance.timing&&performance),s=(e&&e.timing&&e.timing.navigationStart||(e=!1),k._=">");k.drift=0,k.is=function(a,n,j){var g=n&&a&&a[c]&&a[c][s]||j;if(g)return z(g=g[n])?g:-1/0},k.lex=function(){return k().toString(36).replace(".","")},k.ify=function(a,n,j,g,d){if(!a||!a[c]){if(!d)return;a=p.soul.ify(a,d)}var r=i(a[c],s);return t!==n&&n!==c&&(z(j)&&(r[n]=j),t!==g&&(a[n]=g)),a},k.to=function(a,n,j){var g=(a||{})[n];return o(g)&&(g=A(g)),k.ify(j,n,k.is(a,n),g,p.soul(a))},function(){function a(n,j){c!==j&&k.ify(this.o,j,this.s)}k.map=function(n,j,g){var d,r=o(r=n||j)?r:null;return n=f(n=n||j)?n:null,r&&!n?(j=z(j)?j:k(),r[c]=r[c]||{},q(r,a,{o:r,s:j}),r):(g=g||o(j)?j:d,j=z(j)?j:k(),function(v,B,G,E){if(!n)return a.call({o:G,s:j},v,B),v;n.call(g||this||{},v,B,G,E),l(G,B)&&d===G[B]||a.call({o:G,s:j},v,B)})}}();var t,h=b.obj,i=h.as,l=h.has,o=h.is,q=h.map,A=h.copy,z=b.num.is,f=b.fn.is,c=p._;F.exports=k})(x,"./state"),x(function(F){var b=x("./type"),p=x("./val"),k=x("./node"),m={};!function(){function q(z,f){if(!z||f!==k.soul(z)||!k.is(z,this.fn,this.as))return!0;this.cb&&(A.n=z,A.as=this.as,this.cb.call(A.as,z,f,A))}function A(z){z&&k.is(A.n,z,A.as)}m.is=function(z,f,c,a){return!(!z||!e(z)||h(z))&&!l(z,q,{cb:f,fn:c,as:a})}}(),function(){function q(c,a){var n;return(n=function(j,g){for(var d,r=j.seen,v=r.length;v--;)if(d=r[v],g.obj===d.obj)return d;r.push(g)}(c,a))?n:(a.env=c,a.soul=z,k.ify(a.obj,A,a)&&(a.link=a.link||p.link.ify(k.soul(a.node)),a.obj!==c.shell&&(c.graph[p.link.is(a.link)]=a.node)),a)}function A(c,a,n){var j,g,d=this,r=d.env;if(k._===a&&t(c,p.link._))return n._;if(j=f(c,a,n,d,r)){if(a||(d.node=d.node||n||{},t(c,k._)&&k.soul(c)&&(d.node._=o(c._)),d.node=k.soul.ify(d.node,p.link.is(d.link)),d.link=d.link||p.link.ify(k.soul(d.node))),(g=r.map)&&(g.call(r.as||{},c,a,n,d),t(n,a))){if(c=n[a],u===c)return void s(n,a);if(!(j=f(c,a,n,d,r)))return}if(!a)return d.node;if(!0===j)return c;if((g=q(r,{obj:c,path:d.path.concat(a)})).node)return g.link}}function z(c){var a=this,n=p.link.is(a.link),j=a.env.graph;a.link=a.link||p.link.ify(c),a.link[p.link._]=c,a.node&&a.node[k._]&&(a.node[k._][p.link._]=c),t(j,n)&&(j[c]=j[n],s(j,n))}function f(c,a,n,j,g){var d;return!!p.is(c)||(e(c)?1:(d=g.invalid)?f(c=d.call(g.as||{},c,a,n),a,n,j,g):(g.err="Invalid value at '"+j.path.concat(a).join(".")+"'!",void(b.list.is(c)&&(g.err+=" Use `.set(item)` instead of an Array."))))}m.ify=function(c,a,n){var j={path:[],obj:c};return a?"string"==typeof a?a={soul:a}:"function"==typeof a&&(a.map=a):a={},"string"==typeof n&&(a.soul=a.soul||n,n=u),a.soul&&(j.link=p.link.ify(a.soul)),a.shell=(n||{}).shell,a.graph=a.graph||{},a.seen=a.seen||[],a.as=a.as||n,q(a,j),a.root=j.node,a.graph}}(),m.node=function(q){var A=k.soul(q);if(A)return i({},A,q)},function(){function q(A,z){var f,c;if(k._!==z)(f=p.link.is(A))?(c=this.opt.seen[f])?this.obj[z]=c:this.obj[z]=this.opt.seen[f]=m.to(this.graph,f,this.opt):this.obj[z]=A;else{if(h(A,p.link._))return;this.obj[z]=o(A)}}m.to=function(A,z,f){if(A){var c={};return f=f||{seen:{}},l(A[z],q,{obj:c,graph:A,opt:f}),c}}}(),b.fn.is;var u,y=b.obj,e=y.is,s=y.del,t=y.has,h=y.empty,i=y.put,l=y.map,o=y.copy;F.exports=m})(x,"./graph"),x(function(F){x("./onto"),F.exports=function(b,p){if(this.on){if("function"!=typeof b){if(!b||!p)return;var k=b["#"]||b,m=(this.tag||"")[k];return m?(m=this.on(k,p),clearTimeout(m.err),!0):void 0}k=p&&p["#"]||Math.random().toString(36).slice(2);if(!b)return k;var u=this.on(k,b,p);return u.err=u.err||setTimeout(function(){u.next({err:"Error: No ACK yet.",lack:!0}),u.off()},(this.opt||{}).lack||9000),k}}})(x,"./ask"),x(function(F){var b=x("./type");F.exports=function(p){var k={s:{}},m=k.s;p=p||{max:1000,age:27000},k.check=function(y){return!!m[y]&&u(y)};var u=k.track=function(y){var e=m[y]||(m[y]={});return e.was=+new Date(),k.to||(k.to=setTimeout(k.drop,p.age+9)),e};return k.drop=function(y){var e=+new Date();b.obj.map(m,function(s,t){s&&(y||p.age)>e-s.was||delete m[t]}),k.to=null,console.STAT&&(y=+new Date()-e)>9&&console.STAT(e,y,"dup drop")},k}})(x,"./dup"),x(function(F){function b(g){return g instanceof b?(this._={$:this}).$:this instanceof b?b.create(this._={$:this,opt:g}):new b(g)}b.is=function(g){return g instanceof b||g&&g._&&g===g._.$||!1},b.version=.202,b.chain=b.prototype,b.chain.toJSON=function(){};var p=x("./type");p.obj.to(p,b),b.HAM=x("./HAM"),b.val=x("./val"),b.node=x("./node"),b.state=x("./state"),b.graph=x("./graph"),b.on=x("./onto"),b.ask=x("./ask"),b.dup=x("./dup"),b.puff=x("./puff"),function(){function g(w){if(w)if(w.out!==g){var C,K=this.as,J=K.at||K,L=J.$,N=J.dup,M=w.DBG;(C=w["#"])||(C=w["#"]=s(9)),N.check(C)||(N.track(C),C=w._,w._="function"==typeof C?C:function(){},w.$&&w.$===(w.$._||"").$||(w.$=L),J.ask(w["@"],w)||(M&&(M.u=+new Date()),w.get&&b.on._get(w,L),!w.put)?(M&&(M.uc=+new Date()),this.to.next(w),M&&(M.ua=+new Date()),w.out=g,J.on("out",w),M&&(M.ue=+new Date())):d(w))}else this.to.next(w)}function d(w){if(w){var C,K,J=w._||"",L=J.root=((J.$=w.$||"")._||"").root,N=w.put,M=w["#"],P=J.DBG=w.DBG;if(N["#"]&&N["."])L.on("put",w);else{J.out=w,J.lot={s:0,more:1};var S=+new Date();for(var Q in(P&&(P.p=S),N)){var W,R=N[Q];if(!R){C=G+E(Q)+"no node.";break}if(!(K=R._)){C=G+E(Q)+"no meta.";break}if(Q!==K[z]){C=G+E(Q)+"soul not same.";break}if(!(W=K[n])){C=G+E(Q)+"no state.";break}for(var T in R)if(c!==T){var U=R[T],V=W[T];if(k===V){C=G+E(T)+"on"+E(Q)+"no state.";break}if(!a(U)){C=G+E(T)+"on"+E(Q)+"bad "+typeof U+E(U);break}r(U,T,Q,V,w)}if(C)break}P&&(P.pe=+new Date()),console.STAT&&(console.STAT(S,+new Date()-S,"mix"),console.STAT(S,J.lot.s,"mix #")),(J.err=C)?L.on("in",{"@":M,err:b.log(C)}):(--J.lot.more||B(J),J.stun||w["@"]||L.on("in",{"@":M,ok:-1}))}}}function r(w,C,K,J,L){var N,M=L._||"",P=M.root,S=P.graph[K]||j,Q=A(S,C,1),W=S[C],R=H(),T=I(R,J,Q,w,W);if(!T.incoming){if(T.defer){var U=J-R;return setTimeout(function(){r(w,C,K,J,L)},U>D?D:U),M.to||P.on("in",{"@":L["#"],err:U}),M.to=1,U}if(!M.miss)return}(N=M.lot||"").s++,N.more++,(M.stun||(M.stun={}))[K+C]=1;var V=M.DBG;V&&(V.ph=V.ph||+new Date()),P.on("put",{"#":L["#"],"@":L["@"],put:{"#":K,".":C,":":w,">":J},_:M})}function v(w){var C;(C=(w._||"").DBG)&&(C.pa=+new Date(),C.pm=C.pm||+new Date());var K,J=this.as.graph,L=w._,N=w.put,M=N["#"],P=N["."],S=N[":"],Q=N[">"];w["#"],J[M]=q(J[M],P,Q,S,M),function(W,R,T,U,V){var ba,X,Y=W.root;if((Y.opt||"").super&&Y.$.get(R),!(Y&&(X=Y.next)&&(X=X[R])&&X.$))return;(ba=W.put||(W.put={}))[R]=q(ba[R],T,V,U,R),X.put=q(X.put,T,V,U,R)}(L,M,P,k!==(K=N["="])?K:S,Q),(K=L.out)&&(K=K.put)&&(K[M]=q(K[M],P,Q,S,M)),--L.lot.more||B(L),this.to.next(w)}function B(w){if(!w.err){var C,K={},J=((w.$||"")._||"").root,L=(J||"").next||"",N=w.put,M=+new Date();for(var P in N){var S=N[P];(C=L[P])&&C.$&&(J.stop=K,C.on("in",{$:C.$,get:P,put:S}),J.stop=null)}console.STAT&&console.STAT(M,+new Date()-M,"fire"),w.DBG&&(w.DBG.f=+new Date()),(C=w.out)&&(C.out=g,J.on("out",C))}}b.create=function(w){w.root=w.root||w,w.graph=w.graph||{},w.on=w.on||b.on,w.ask=w.ask||b.ask,w.dup=w.dup||b.dup();var C=w.$.opt(w.opt);return w.once||(w.on("in",g,w),w.on("out",g,w),w.on("put",v,w),b.on("create",w),w.on("create",w)),w.once=1,C},b.on.put=d;var G="Error: Invalid graph!",E=function(w){return" '"+(""+w).slice(0,9)+"...' "},I=b.HAM,D=2147483647,H=b.state}(),function(){function g(E,I,D,H){var w=this,C=b.state.is(D,I);if(!C)return w.err="Error: No state on '"+I+"' in node '"+H+"'!";var K=w.graph[H]||j,J=b.state.is(K,I,!0),L=K[I],N=b.HAM(w.machine,C,J,E,L);N.incoming?(w.put[H]=b.state.to(D,I,w.put[H]),(w.diff||(w.diff={}))[H]=b.state.to(D,I,w.diff[H]),w.souls[H]=!0):N.defer&&(w.defer=C<(w.defer||1/0)?C:w.defer)}function d(E,I){var D=this,H=D.$._,w=(H.next||j)[I];if(!w){if(!(H.opt||j).super)return void(D.souls[I]=!1);w=D.$.get(I)._}var C=D.map[I]={put:E,get:I,$:w.$},K={ctx:D,msg:C};D.async=!!H.tag.node,D.ack&&(C["@"]=D.ack),o(E,r,K),D.async&&(D.and||H.on("node",function(J){this.to.next(J),J===D.map[J.get]&&(D.souls[J.get]=!1,o(J.put,v,J),o(D.souls,function(L){if(L)return L})||D.c||(D.c=1,this.off(),o(D.map,B,D)))}),D.and=!0,H.on("node",C))}function r(E,I){var D=this.ctx,H=D.graph,w=this.msg,C=w.get,K=w.put,J=w.$._;H[C]=b.state.to(K,I,H[C]),D.async||(J.put=b.state.to(K,I,J.put))}function v(E,I){var D=this.put,H=this.$._;H.put=b.state.to(D,I,H.put)}function B(E,I){E.$&&(this.cat.stop=this.stop,E.$._.on("in",E),this.cat.stop=null)}function G(E,I){if(E!==this.graph[I])return!0}b.on._put=function(E,I){var D=I._,H={$:I,graph:D.graph,put:{},map:{},souls:{},machine:b.state(),ack:E["@"],cat:D,stop:{}};if(b.obj.map(E.put,G,H)){if(b.graph.is(E.put,null,g,H)||(H.err="Error: Invalid graph!"),H.err)return D.on("in",{"@":E["#"],err:b.log(H.err)});if(o(H.put,d,H),H.async||o(H.map,B,H),k!==H.defer){var w=H.defer-H.machine;setTimeout(function(){b.on._put(E,I)},w>MD?MD:w)}H.diff&&D.on("put",l(E,{put:H.diff}))}},b.on._get=function(E,I){var D=I._,H=E.get,w=H[z],C=D.graph[w],K=H[f],J=(D.next||(D.next={}))[w],L=(E._||"").DBG=E.DBG;if(L&&(L.g=+new Date()),!C)return D.on("get",E);if(K){if("string"!=typeof K||!i(C,K))return D.on("get",E);C=b.state.to(C,K)}else C=b.window?b.obj.copy(C):C;C=b.graph.node(C),(J||j).ack;var N=function(){};N.ram=N.faith=!0,N.$=E.$,L&&(L.ga=+new Date()),D.on("in",{"@":E["#"],put:C,ram:1,$:I,_:N}),L&&(L.gm=+new Date()),D.on("get",E),L&&(L.gd=+new Date())}}(),b.chain.opt=function(g){g=g||{};var d=this._,r=g.peers||g;return h(g)||(g={}),h(d.opt)||(d.opt=g),e(r)&&(r=[r]),u(r)&&(r=o(r,function(v,B,G){(B={}).id=B.url=v,G(v,B)}),h(d.opt.peers)||(d.opt.peers={}),d.opt.peers=l(r,d.opt.peers)),d.opt.peers=d.opt.peers||{},o(g,function v(B,G){!i(this,G)||y.is(B)||t.empty(B)?this[G]=B:B&&B.constructor!==Object&&!u(B)||o(B,v,this[G])},d.opt),b.on("opt",d),b.obj.native(),this},b.obj.native=function(){var g=Object.prototype;for(var d in g)console.log("Native Object.prototype polluted, reverting",d),delete g[d]};var k,m,u=b.list.is,y=b.text,e=y.is,s=y.random,t=b.obj,h=(t.empty,t.is),i=t.has,l=t.to,o=t.map,q=(t.copy,b.state.lex,b.state.ify),A=b.state.is,z=b.val.link._,f=".",c=b.node._,a=b.val.is,n=(b.val.link.is,b.state._),j={};b.log=function(){return!b.log.off&&m.log.apply(m,arguments),[].slice.call(arguments).join(" ")},b.log.once=function(g,d,r){return(r=b.log.once)[g]=r[g]||0,r[g]++||b.log(d)},"undefined"!=typeof window&&((window.GUN=window.Gun=b).window=window);try{void 0!==O&&(O.exports=b)}catch(g){}F.exports=b,(b.window||"").console=(b.window||"").console||{log:function(){}},(m=console).only=function(g,d){return m.only.i&&g===m.only.i&&m.only.i++&&(m.log.apply(m,arguments)||d)}})(x,"./root"),x(function(F){var b=x("./root");b.chain.back=function(m,u){if(-1===(m=m||1)||1/0===m)return this._.root.$;if(1===m)return(this._.back||this._).$;var y=this._;if("string"==typeof m&&(m=m.split(".")),m instanceof Array){for(var e=0,s=m.length,t=y;e<s;e++)t=(t||k)[m[e]];return p!==t?u?this:t:(t=y.back)?t.$.back(m,u):void 0}if("function"==typeof m){var h;for(t={back:y};(t=t.back)&&p===(h=m(t,u)););return h}return b.num.is(m)?(y.back||y).$.back(m-1):this};var p,k={}})(x,"./back"),x(function(F){var b=x("./root");function p(a){var n,j,g=this.as,d=g.back,r=g.root;if(a.$||(a.$=g.$),this.to.next(a),n=a.get){if(g.lex&&(a.get=A(g.lex,a.get)),n["#"]||g.soul){if(n["#"]=n["#"]||g.soul,a["#"]||(a["#"]=f(9)),d=r.$.get(n["#"])._,n=n["."]){if(o(d.put,n)){if((j=(v=d.$.get(n)._).ack)||(v.ack=-1),d.on("in",{$:d.$,put:b.state.to(d.put,n),get:d.get}),j)return}else if("string"!=typeof n){var v={},B=(d.put||{})._;if(b.obj.map(d.put,function(G,E){b.text.match(E,n)&&(v[E]=G)}),b.obj.empty(v)||(v._=B,d.on("in",{$:d.$,put:v,get:d.get})),j=g.lex){if(j=j._||(j._=function(){}),d.ack<j.ask&&(j.ask=d.ack),j.ask)return;j.ask=1}}}else{if((j=d.ack)||(d.ack=-1),o(d,"put")&&d.on("in",d),j&&h!==d.put)return;a.$=d.$}return r.ask(t,a),r.on("in",a)}if(r.now&&(r.now[g.id]=r.now[g.id]||!0,g.pass={}),n["."])return g.get?(a={get:{".":g.get},$:g.$},d.ask||(d.ask={}),d.ask[g.get]=a.$._,d.on("out",a)):(a={get:{},$:g.$},d.on("out",a));if(g.ack=g.ack||-1,g.get)return a.$=g.$,n["."]=g.get,(d.ask||(d.ask={}))[g.get]=a.$._,d.on("out",a)}return d.on("out",a)}function k(a){var n,j,g=this,d=g.as,r=d.root,v=(a.$||i)._||i,B=a.put;if(d.get&&a.get!==d.get&&(a=A(a,{get:d.get})),d.has&&v!==d&&(a=A(a,{$:d.$}),v.ack&&(d.ack=v.ack)),h===B)return(j=v.put,g.to.next(a),d.soul)?void 0:h===j&&h!==v.put?void 0:(u(d,a,g),d.has&&s(d,a),q(v.echo,d.id),void q(d.map,v.id));if(d.soul)return g.to.next(a),u(d,a,g),void(d.next&&z(B,e,{msg:a,cat:d}));if(!(n=b.val.link.is(B)))return b.val.is(B)?(d.has||d.soul?s(d,a):(v.has||v.soul)&&((v.echo||(v.echo={}))[d.id]=v.echo[v.id]||d,(d.map||(d.map={}))[v.id]=d.map[v.id]||{at:v}),g.to.next(a),void u(d,a,g)):(d.has&&v!==d&&o(v,"put")&&(d.put=v.put),(n=b.node.soul(B))&&v.has&&(v.put=d.root.$.get(n)._.put),j=(r.stop||{})[v.id],g.to.next(a),m(d,a,v,n),u(d,a,g),void(d.next&&z(B,e,{msg:a,cat:d})));r.stop,(j=(j=r.stop||{})[v.id]||(j[v.id]={})).is=j.is||v.put,j[d.id]=v.put||!0,g.to.next(a),m(d,a,v,n),u(d,a,g)}function m(a,n,j,g){if(g&&c!==a.get){var d=a.root.$.get(g)._;a.has?j=d:j.has&&m(j,n,j,g),j!==a&&(j.$||(j={}),(j.echo||(j.echo={}))[a.id]=j.echo[a.id]||a,a.has&&!(a.map||i)[j.id]&&s(a,n),(g!==(d=j.id?(a.map||(a.map={}))[j.id]=a.map[j.id]||{at:j}:{}).link||d.pass||a.pass)&&(a.pass&&(b.obj.map(a.map,function(r){r.pass=!0}),q(a,"pass")),d.pass&&q(d,"pass"),a.has&&(a.link=g),function(r,v){var B=r.root.$.get(v)._,G=r.lex;if((r.ack||G)&&((G=G||{})["#"]=v,B.on("out",{get:G}),!r.ask))return;B=r.ask,b.obj.del(r,"ask"),z(B||r.next,function(E,I){var D=E.lex||{};D["#"]=v,D["."]=D["."]||I,E.on("out",{get:D})}),b.obj.del(r,"ask")}(a,d.link=g)))}}function u(a,n,j){a.echo&&z(a.echo,y,n)}function y(a){a&&a.on&&a.on("in",this)}function e(a,n){var j,g,d,r=this.cat.next||i,v=this.msg;(c!==n||r[n])&&(g=r[n])&&(g.has?(h!==g.put&&b.val.link.is(a)||(g.put=a),j=g.$):(d=v.$)&&(d=(j=v.$.get(n))._,h!==d.put&&b.val.link.is(a)||(d.put=a)),g.on("in",{put:a,get:n,$:j,via:v}))}function s(a,n){if(a.has||a.soul){var j=a.map;a.root,a.map=null,a.has&&(a.dub&&a.root.stop&&(a.dub=null),a.link=null),(a.pass||n["@"]||null!==j)&&(h===j&&b.val.link.is(a.put)||(z(j,function(g){(g=g.at)&&q(g.echo,a.id)}),j=a.put,z(a.next,function(g,d){if(h===j&&h!==a.put)return!0;g.put=h,g.ack&&(g.ack=-1),g.on("in",{get:d,$:g.$,put:h})})))}}function t(a,n){var j=this.as,g=j.get||"",d=j.$._,r=(a.put||"")[g["#"]];if(d.ack&&(d.ack=d.ack+1||1),a.put&&("string"!=typeof g["."]||o(r,d.get)))c!=g["."]?(d.$===(a._||"").$&&(a._.miss=d.put===h),b.on.put(a)):d.on("in",{get:d.get,put:b.val.link.ify(g["#"]),$:d.$,"@":a["@"]});else{if(d.put!==h)return;d.on("in",{get:d.get,put:d.put=h,$:d.$,"@":a["@"]})}}b.chain.chain=function(a){var n,j=this._,g=new(a||this).constructor(this),d=g._;return d.root=n=j.root,d.id=++n.once,d.back=this._,d.on=b.on,d.on("in",k,d),d.on("out",p,d),g};var h,i={},l=b.obj,o=l.has,q=(l.put,l.del),A=l.to,z=l.map,f=b.text.random,c=(b.val.link._,b.node._)})(x,"./chain"),x(function(F){var b=x("./root");function p(i){var l,o=this,q=o.as,A=q.at.root,z=(i.$||{})._||{},f=i.put||z.put;if((l=A.now)&&o!==l[q.now])return o.to.next(i);if(o.seen&&z.id&&o.seen[z.id])return o.to.next(i);if((l=f)&&l[s._]&&(l=s.is(l))&&(l=(i.$$=z.root.$.get(l))._,m!==l.put&&(i=y(i,{put:f=l.put}))),(l=A.mum)&&z.id){var c=z.id+(o.id||(o.id=b.text.random(9)));if(l[c])return;m===f||s.is(f)||(l[c]=!0)}q.use(i,o),o.stun?o.stun=null:o.to.next(i)}function k(i){var l=this.on;if(!i||l.soul||l.has)return this.off();if(i=(i=(i=i.$||i)._||i).id){var o;l.map;if((o=this.seen||(this.seen={}))[i])return!0;o[i]=!0}}b.chain.get=function(i,l,o){var q;if("string"!=typeof i){if("function"==typeof i){if(!0===l)return function(n,j,g,d){var r,v=n._,B=0;if(r=v.soul||v.link||v.dub)return j(r,d,v);if(v.jam)return v.jam.push([j,d]);v.jam=[[j,d]],n.get(function(G,E){if(!(m===G.put&&!v.root.opt.super&&(r=Object.keys(v.root.opt.peers).length)&&++B<=r)){E.rid(G);var I,D=(D=G.$)&&D._||{},H=0;for(r=v.jam,delete v.jam;I=r[H++];){var w=I[0];I=I[1],w&&w(D.link||D.soul||s.is(G.put)||t(G.put)||D.dub,I,G,E)}}},{out:{get:{".":!0}}})}(this,i,0,o),this;var A,z=(q=this)._,f=z.root,c=f.now;(o=l||{}).at=z,o.use=i,o.out=o.out||{},o.out.get=o.out.get||{},(A=z.on("in",p,o)).rid=k,(f.now={$:1})[o.now=z.id]=A;var a=f.mum;return f.mum={},z.on("out",o.out),f.mum=a,f.now=c,q}return e(i)?this.get(""+i,l,o):(c=s.is(i))?this.get(c,l,o):u.is(i)?(q=this,(c=((c=i["#"])||h)["="]||c)&&(q=q.get(c)),q._.lex=i,q):((o=this.chain())._.err={err:b.log("Invalid get request!",i)},l&&l.call(o,o._.err),o)}return(q=(this._.next||h)[i])||(q=function(n,j){var g=j._,d=g.next,r=j.chain()._;return d||(d=g.next={}),d[r.get=n]=r,j===g.root.$?r.soul=n:(g.soul||g.has)&&(r.has=n),r}(i,this)),q=q.$,(c=this._.stun)&&(q._.stun=q._.stun||c),l&&"function"==typeof l&&q.get(l,o),q};var m,u=b.obj,y=(u.map,u.has,b.obj.to),e=b.num.is,s=b.val.link,t=b.node.soul,h=(b.node._,{})})(x,"./get"),x(function(F){var b=x("./root");function p(f){f&&f()}function k(){var f=this;f.graph&&l(f.stun)&&(f.res=f.res||function(c){c&&c()},f.res(function(){delete f.via._.stun;var c=f.$.back(-1)._,a=c.ask(function(d){c.root.on("ack",d),d.err&&b.log(d),++n>(f.acks||0)&&this.off(),f.ack&&f.ack(d,this)},f.opt),n=0,j=c.root.now;t.del(c.root,"now");var g=c.root.mum;c.root.mum={},f.ref._.on("out",{$:f.ref,put:f.out=f.env.graph,opt:f.opt,"#":a}),c.root.mum=g?t.to(g,c.root.mum):g,c.root.now=j,f.via._.on("res",{}),delete f.via._.tag.res},f),f.res&&f.res())}function m(f,c,a,n){var j=this,g=b.is(f);!c&&n.path.length&&(j.res||A)(function(){for(var d=n.path,r=j.ref,v=(j.opt,0),B=d.length;v<B;v++)r=r.get(d[v]);g&&(r=f);var G=r._.dub;if(G||(G=b.node.soul(n.obj)))return r.back(-1).get(G),void n.soul(G);(j.stun=j.stun||{})[d]=1,r.get(u,!0,{as:{at:n,as:j,p:d,ref:r}})},{as:j,at:n})}b.chain.put=function(f,c,a){var n,j=this,g=j._,d=g.root.$;return d._,(a=a||{}).data=f,a.via=a.$=a.via||a.$||j,"string"==typeof c?a.soul=c:a.ack=a.ack||c,g.soul&&(a.soul=g.soul),a.soul||d===j?h(a.data)?(a.soul=a.soul||(a.not=b.node.soul(a.data)||(a.via.back("opt.uuid")||b.text.random)()),a.via._.stun={},a.soul?(a.$=d.get(a.soul),a.ref=a.$,function(r){r.batch=k;var v=r.opt||{},B=r.env=b.state.map(m,v.state);if(B.soul=r.soul,r.graph=b.graph.ify(r.data,B,r),B.err)return(r.ack||q).call(r,r.out={err:b.log(B.err)}),void(r.res&&r.res());r.batch()}(a),j):(a.via.back("opt.uuid")(function(r,v){if(r)return b.log(r);(a.ref||a.$).put(a.data,a.soul=v,a)}),j)):((a.ack||q).call(a,a.out={err:b.log("Data saved to the root level of the graph must be a node (an object), not a",typeof a.data,'of "'+a.data+'"!')}),a.res&&a.res(),j):(a.via._.stun={},b.is(f)?(f.get(function(r,v,B){if(!r)return delete a.via._.stun,b.log("The reference you are saving is a",typeof B.put,'"'+B.put+'", not a node (object)!');j.put(b.val.link.ify(r),c,a)},!0),j):(g.has&&(n=b.val.link.is(f))&&(g.dub=n),a.ref=a.ref||d._===(n=g.back)?j:n.$,a.ref._.soul&&b.val.is(a.data)&&g.get?(a.data=i({},g.get,a.data),a.ref.put(a.data,a.soul,a),j):(a.ref.get(e,!0,{as:a}),a.out||(a.res=a.res||p,a.$._.stun=a.ref._.stun),j)))},String.fromCharCode(31);function u(f,c,a,n){(c=c.as).p;var j,g=c.ref,d=c.at,r=[];c=c.as,g.back(function(B){if(j=B.soul||B.link||B.dub)return j;r.push(B.has||B.get)}),r=[j||c.soul].concat(r.reverse());var v=((a||{}).$||{})._||{};f=v.dub=v.dub||f||b.node.soul(d.obj)||b.node.soul(a.put||v.put)||b.val.link.is(a.put||v.put)||r.join("/"),n&&(n.stun=!0),f?y(v,v.dub=f,d,c):c.via.back("opt.uuid")(function(B,G){if(B)return b.log(B);y(v,v.dub=v.dub||G,d,c)})}function y(f,c,a,n){f.$.back(-1).get(c),a.soul(c),delete n.stun[a.path],n.batch()}function e(f,c,a,n){if(c=c.as,a.$&&a.$._)if(a.err)b.log("Please report this as an issue! Put.any.err");else{var j,g=a.$._,d=g.put,r=c.opt||{};if(!(j=c.ref)||!j._.now){if(n&&(n.stun=!0),c.ref!==c.$){if(!(j=c.$._.get||g.get))return delete c.via._.stun,void b.log("Please report this as an issue! Put.no.get");c.data=i({},j,c.data),j=null}if(s===d){if(!g.get)return void delete c.via._.stun;f||(j=g.$.back(function(v){if(v.link||v.soul)return v.link||v.soul;c.data=i({},v.get,c.data)}),c.not=!0),g=(j=j||g.soul||g.link||g.dub)?g.root.$.get(j)._:g,c.soul=j,d=c.data}c.not||(c.soul=c.soul||f)||(c.path&&h(c.data)?c.soul=(r.uuid||c.via.back("opt.uuid")||b.text.random)():(z==g.get&&(c.soul=(g.put||o)["#"]||g.dub),c.soul=c.soul||g.soul||g.link||(r.uuid||c.via.back("opt.uuid")||b.text.random)()),c.soul)?c.ref.put(c.data,c.soul,c):c.via.back("opt.uuid")(function(v,B){if(v)return delete c.via._.stun,b.log(v);c.ref.put(c.data,c.soul=B,c)})}}}var s,t=b.obj,h=t.is,i=t.put,l=(t.map,t.empty),o={},q=function(){},A=function(f,c){f.call(c||o)},z=b.node._})(x,"./put"),x(function(F){var b=x("./root");x("./chain"),x("./back"),x("./put"),x("./get"),F.exports=b})(x,"./index"),x(function(F){var b=x("./index");function p(h,i){var l,o=h.$,q=((o||{})._||{}).put||h.put;this.at;if(m!==q){if(l=h.$$){if(l=h.$$._,m===l.put)return;q=l.put}this.change&&(q=h.put),this.as?this.ok.call(this.as,h,i):this.ok.call(o,q,h.get,h,i)}}function k(h,i,l){if(h.$){var o,q,A=this.as,z=(A.at,h.$),f=z._,c=f.put||h.put;(q=h.$$)&&(o=q=h.$$._,m!==o.put&&(c=o.put)),(q=i.wait)&&(q=q[f.id])&&clearTimeout(q),i.ack=(i.ack||0)+1,!l&&m===c&&!f.root.opt.super&&i.ack<=(A.acks||Object.keys(f.root.opt.peers).length)||(!l&&(m===c||f.soul||f.link||o&&!(0<o.ack))||m===c&&!f.root.opt.super&&(q=Object.keys(f.root.opt.peers).length)&&!l&&(o||f).ack<q?q=(i.wait={})[f.id]=setTimeout(function(){k.call({as:A},h,i,q||1)},A.wait||99):(o&&m===o.put&&(q=s.is(c))&&(c=b.node.ify({},q)),i.rid?i.rid(h):i.off(),A.ok.call(z||A.$,c,h.get)))}else i.off()}b.chain.on=function(h,i,l,o){var q,A=this._;if("string"==typeof h)return i?(q=A.on(h,i,l||A,o),l&&l.$&&(l.subs||(l.subs=[])).push(q),this):A.on(h);var z=i;return(z=!0===z?{change:!0}:z||{}).at=A,z.ok=h,this.get(p,z),this},b.chain.val=function(h,i){return b.log.once("onceval","Future Breaking API Change: .val -> .once, apologies unexpected."),this.once(h,i)},b.chain.once=function(h,i){var l=this,o=l._,q=o.put;if(0<o.ack&&m!==q)return(h||t).call(l,q,o.get),l;if(!h){b.log.once("valonce","Chainable val is experimental, its behavior and API may change moving forward. Please play with it and report bugs and ideas on how to improve it.");var A=l.chain();return A._.nix=l.once(function(){A._.on("in",l._)}),A}return(i=i||{}).ok=h,i.at=o,i.out={"#":b.text.random(9)},l.get(k,{as:i}),i.async=!0,l},b.chain.off=function(){var h,i=this._,l=i.back;if(l)return i.ack=0,(h=l.next)&&h[i.get]&&e(h,i.get),(h=l.ask)&&e(h,i.get),(h=l.put)&&e(h,i.get),(h=i.soul)&&e(l.root.graph,h),(h=i.map)&&y(h,function(o){o.link&&l.root.$.get(o.link).off()}),(h=i.next)&&y(h,function(o){o.$.off()}),i.on("off",{}),this};var m,u=b.obj,y=u.map,e=(u.has,u.del),s=(u.to,b.val.link),t=function(){}})(x,"./on"),x(function(F){var b=x("./index");function p(e){if(!e.put||b.val.is(e.put))return this.to.next(e);this.as.nix&&this.off(),m(e.put,k,{at:this.as,msg:e}),this.to.next(e)}function k(e,s){if(y!==s){var t=this.msg.$,h=t._,i=this.at,l=h.lex;l&&!b.text.match(s,l["."]||l["#"]||l)||(((l=t.get(s)._).echo||(l.echo={}))[i.id]=l.echo[i.id]||i)}}b.chain.map=function(e,s,t){var h,i=this._;return e?(b.log.once("mapfn","Map functions are experimental, their behavior and API may change moving forward. Please play with it and report bugs and ideas on how to improve it."),h=this.chain(),this.map().on(function(l,o,q,A){var z=(e||u).call(this,l,o,q,A);if(void 0!==z)return l===z?h._.on("in",q):b.is(z)?h._.on("in",z._):void h._.on("in",{get:o,put:z})}),h):(h=i.each)?h:(i.each=h=this.chain(),h._.nix=this.back("nix"),this.on("in",p,h._),h)};var m=b.obj.map,u=function(){},y=b.node._})(x,"./map"),x(function(F){var b=x("./index");function p(){return b.state.lex()+b.text.random(7)}b.chain.set=function(k,m,u){var y,e=this;return m=m||function(){},(u=u||{}).item=u.item||k,(y=b.node.soul(k))&&(k=b.obj.put({},y,b.val.link.ify(y))),b.is(k)?(k.get(function(s,t,h){if(s||!k._.stun)return s?void e.put(b.obj.put({},s,b.val.link.ify(s)),m,u):m.call(e,{err:b.log('Only a node can be linked! Not "'+h.put+'"!')});k._.on("res",function(){this.off(),e.set(k,m,u)})},!0),k):(b.obj.is(k)&&(y=y||b.node.soul(k)||p()),e.get(y||p()).put(k,m,u))}})(x,"./set"),x(function(F){if("undefined"!=typeof Gun){var b;try{b=(Gun.window||function(){}).localStorage}catch(p){}b||(Gun.log("Warning: No localStorage exists to persist data to!"),b={setItem:function(p,k){this[p]=k},removeItem:function(p){delete this[p]},getItem:function(p){return this[p]}}),Gun.on("create",function(p){var k=this.to,m=p.opt;if(p.once)return k.next(p);if(!1===m.localStorage)return k.next(p);m.prefix=m.file||"gun/";var u,y,e=Gun.obj.ify(b.getItem("gap/"+m.prefix))||{},s=Gun.obj.empty;if(!s(e)){var t=Gun.obj.ify(b.getItem(m.prefix))||{},h={};Gun.obj.map(e,function(q,A){Gun.obj.map(q,function(z,f){h[A]=Gun.state.to(t[A],f,h[A])})}),setTimeout(function(){p.on("out",{put:h,"#":p.ask(i)})},1)}function i(q){if(!q.err&&q.ok){var A=q["@"];setTimeout(function(){Gun.obj.map(e,function(z,f){Gun.obj.map(z,function(c,a){A===c&&delete z[a]}),s(z)&&delete e[f]}),o()},m.wait||1)}}p.on("out",function(q){q.lS||(Gun.is(q.$)&&q.put&&!q["@"]&&(u=q["#"],Gun.graph.is(q.put,null,l),y||(y=setTimeout(o,m.wait||1))),this.to.next(q))}),p.on("ack",i),k.next(p);var l=function(q,A,z,f){(e[f]||(e[f]={}))[A]=u},o=function(){clearTimeout(y),y=!1;try{b.setItem("gap/"+m.prefix,JSON.stringify(e))}catch(q){Gun.log(err=q||"localStorage failure")}}}),Gun.on("create",function(p){this.to.next(p);var k=p.opt;if(!p.once&&!1!==k.localStorage){k.prefix=k.file||"gun/",p.graph;var m,u={},y=0,e=Gun.obj.ify(b.getItem(k.prefix))||{};p.on("localStorage",e),p.on("put",function(t){this.to.next(t);var h,i=t.put,l=i["#"],o=i["."],q=i[":"],A=i[">"];if(e[l]=Gun.state.ify(e[l],o,A,q,l),t["@"]||((u[t["#"]]=h=(t._||"").lot||{}).lS=(h.lS||0)+1),(y+=1)>=(k.batch||1000))return s();m||(m=setTimeout(s,k.wait||1))}),p.on("get",function(t){this.to.next(t);var h,i,l,o=t.get;function q(){if(o&&(h=o["#"])){var A=o["."];(i=e[h]||l)&&A&&(i=Gun.state.to(i,A)),p.on("in",{"@":t["#"],put:Gun.graph.node(i),lS:1})}}Gun.debug?setTimeout(q,1):q()});var s=function(t){var h;y=0,clearTimeout(m),m=!1;var i=u;u={},t&&(e=t);try{b.setItem(k.prefix,JSON.stringify(e))}catch(l){Gun.log(h=(l||"localStorage failure")+" Consider using GUN's IndexedDB plugin for RAD for more storage space, https://gun.eco/docs/RAD#install"),p.on("localStorage:error",{err:h,file:k.prefix,flush:e,retry:s})}(h||Gun.obj.empty(k.peers))&&Gun.obj.map(i,function(l,o){if(l){if(l.more)return void(u[o]=l);l.s!==l.lS&&(h="localStorage batch not same.")}p.on("in",{"@":o,err:h,ok:0})})}}})}})(x,"./adapters/localStorage"),x(function(F){var b=x("../type");!function(){var k=JSON.stringify;function m(y,e){var s;if(!(e instanceof Object))return e;var t=+new Date();return b.obj.map(Object.keys(e).sort(),u,{to:s={},on:e}),console.STAT&&console.STAT(t,+new Date()-t,"sort"),s}function u(y){this.to[y]=this.on[y]}b.obj.hash=function(y,e){if(e||void 0!==(y=k(y,m)))return b.text.hash(e||y||"")},b.obj.hash.sort=m}();var p=b.obj.is;b.obj.map;try{F.exports=function(k){var m=function(){},u=k.opt||{};u.log=u.log||console.log,u.gap=u.gap||u.wait||0,u.pack=u.pack||.3*(u.memory?1000*u.memory*1000:1.399e09),u.puff=u.puff||9;var y=setTimeout.puff||setTimeout,e=k.dup,s=e.check,t=e.track,h=m.hear=function(f,c){if(f){if(u.pack<=f.length)return m.say({dam:"!",err:"Message too big!"},c);var a,n,j,g=f[0];if(m===this&&(h.d+=f.length||0,++h.c),"["!==g){if("{"===g||(f["#"]||p(f))&&(a=f)){try{a=a||JSON.parse(f)}catch(B){return u.log("DAM JSON parse error",B)}if(!a)return;if(a.DBG&&(a.DBG=j={DBG:a.DBG}),j&&(j.hp=+new Date()),(n=a["#"])||(n=a["#"]=b.text.random(9)),g=s(n))return;if((a._=function(){}).via=m.leap=c,g=a.dam)return(g=m.hear[g])&&g(a,c,k),void t(n);var d,r=+new Date();j&&(j.is=r),k.on("in",a),j&&(j.hd=+new Date()),console.STAT&&(d=+new Date()-r)>9&&console.STAT(r,d,"msg"),t(n).via=c,m.leap=null}}else{try{a=JSON.parse(f)}catch(B){u.log("DAM JSON parse error",B)}if(f="",!a)return;console.STAT&&console.STAT(+new Date(),a.length,"# on hear batch");var v=u.puff;!function B(){for(var G,E=+new Date(),I=0;I<v&&(G=a[I++]);)h(G,c);a=a.slice(I),console.STAT&&console.STAT(E,+new Date()-E,"hear loop"),i(c),a.length&&y(B,0)}()}}};function i(f){var c=f.batch,a="string"==typeof c;if(a&&(c+="]"),f.batch=f.tail=null,c&&(a?!(3>c.length):c.length)){if(!a)try{c=1===c.length?c[0]:JSON.stringify(c)}catch(n){return u.log("DAM JSON stringify error",n)}c&&l(c,f)}}function l(f,c){try{var a=c.wire;c.say?c.say(f):a.send&&a.send(f),m.say.d+=f.length||0,++m.say.c}catch(n){(c.queue=c.queue||[]).push(f)}}h.c=h.d=0,q=0,A=m.say=function(f,c){var a,n,j;if((a=this)&&(a=a.to)&&a.next&&a.next(f),!f)return!1;var g=f.DBG;c||(v=+new Date(),g&&(g.y=v));var d=f._||(f._=function(){});if((n=f["#"])||(n=f["#"]=b.text.random(9)),(j=d.raw)||(j=m.raw(f)),v&&console.STAT&&console.STAT(v,+new Date()-v,"say prep"),!o&&t(n),!c&&(a=f["@"])&&(c=(a=e.s[a])&&(a.via||(a=a.it)&&(a=a._)&&a.via)||m.leap),!c&&f["@"])return console.STAT&&console.STAT(+new Date(),++q,"total no peer to ack to"),!1;if(!c&&m.way)return m.way(f);if(c&&c.id){if(!c.wire&&m.wire&&m.wire(c),n!==c.last){if(c.last=n,c===d.via)return!1;if((a=d.to)&&(a[c.url]||a[c.pid]||a[c.id]))return!1;if(c.batch){if(c.tail=(a=c.tail||0)+j.length,c.tail<=u.pack)return void(c.batch+=(a?",":"")+j);i(c)}c.batch="[";var r,v=+new Date();setTimeout(function(){console.STAT&&(r=+new Date()-v)>9&&console.STAT(v,r,"0ms TO",n,c.id),i(c)},u.gap),l(j,c)}}else{if(!b.obj.is(c||u.peers))return!1;u.puff;var B=u.peers,G=Object.keys(c||u.peers||{});!function E(){var I=+new Date();o=1;var D=d.raw;d.raw=j;for(var H,w=0;w<9&&(H=(G||"")[w++]);)(H=B[H])&&A(f,H);d.raw=D,o=0,G=G.slice(w),console.STAT&&console.STAT(I,+new Date()-I,"say loop"),G.length&&(y(E,0),t(f["@"]))}()}},m.say.c=m.say.d=0,function(){m.raw=function(c){if(!c)return"";var a,n=c._||{};if(a=n.raw)return a;if("string"==typeof c)return c;var j=f(c);return n&&(j||"").length<100000&&(n.raw=j),j};var f=JSON.stringify}(),m.hi=function(f){var c=f.wire||{};f.id?u.peers[f.url||f.id]=f:(c=f.id=f.id||b.text.random(9),m.say({dam:"?",pid:k.opt.pid},u.peers[c]=f),delete e.s[f.last]),f.met=f.met||+new Date(),c.hied||k.on(c.hied="hi",f),c=f.queue,f.queue=[],b.obj.map(c,function(a){l(a,f)}),b.obj.native&&b.obj.native()},m.bye=function(f){k.on("bye",f);var c=+new Date();c-=f.met||c,m.bye.time=((m.bye.time||c)+c)/2},m.hear["!"]=function(f,c){u.log("Error:",f.err)},m.hear["?"]=function(f,c){f.pid&&(c.pid||(c.pid=f.pid),f["@"])||(m.say({dam:"?",pid:u.pid,"@":f["#"]},c),delete e.s[c.last])},k.on("create",function(f){f.opt.pid=f.opt.pid||b.text.random(9),this.to.next(f),f.on("out",m.say)}),k.on("bye",function(f,c){f=u.peers[f.id||f]||f,this.to.next(f),f.bye?f.bye():(c=f.wire)&&c.close&&c.close(),b.obj.del(u.peers,f.id),f.wire=null});var o,q,A,z={};return k.on("bye",function(f,c){this.to.next(f),(c=f.url)&&(z[c]=!0,setTimeout(function(){delete z[c]},u.lack||9000))}),k.on("hi",function(f,c){this.to.next(f),(c=f.url)&&z[c]&&(delete z[c],u.super||b.obj.map(k.next,function(a,n){(c={})[n]=k.graph[n],m.say({"##":b.obj.hash(c),get:{"#":n}},f)}))}),m}}catch(k){}})(x,"./adapters/mesh"),x(function(F){var b=x("../index");b.Mesh=x("./mesh"),b.on("opt",function(p){this.to.next(p);var k=p.opt;if(!p.once&&!1!==k.WebSocket){var m;"undefined"!=typeof window&&(m=window),"undefined"!=typeof global&&(m=global),m=m||{};var u=k.WebSocket||m.WebSocket||m.webkitWebSocket||m.mozWebSocket;if(u){k.WebSocket=u;var y=k.mesh=k.mesh||b.Mesh(p);y.wire||k.wire,y.wire=k.wire=t,setTimeout(function(){p.on("out",{dam:"hi"})},1);var e=2000,s="undefined"!=typeof document&&document}}function t(i){try{if(!i||!i.url)return o&&o(i);var l=i.url.replace(/^http/,"ws"),o=i.wire=new k.WebSocket(l);return o.onclose=function(){k.mesh.bye(i),h(i)},o.onerror=function(q){h(i)},o.onopen=function(){k.mesh.hi(i)},o.onmessage=function(q){q&&k.mesh.hear(q.data||q,i)},o}catch(q){}}function h(i){clearTimeout(i.defer),s&&i.retry<=0||(i.retry=(i.retry||k.retry||60)-1,i.defer=setTimeout(function l(){if(s&&s.hidden)return setTimeout(l,e);t(i)},e))}})})(x,"./adapters/websocket")}();
