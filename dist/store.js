t="undefined"!=typeof window?window.Gun:require("../gun"),t.on("create",function(a){t.TESTING&&(a.opt.file="radatatest"),this.to.next(a);var c,g=a.opt;if(!1!==g.radisk){var l=t.window&&t.window.Radisk||require("./radisk"),R=l.Radix,C=l(g),q=String.fromCharCode(27),r=0;a.on("put",function(i){if(this.to.next(i),!(i._||"").rad){var d=i["#"],e=i.put,m=e["#"],f=e["."],s=e[":"],D=e[">"],h=(i._||"").DBG;h&&(h.sp=h.sp||+new Date());var j=(i._||"").lot||"";y[d]=(y[d]||0)+1;var n=(i._||"").RPS||((i._||"").RPS=+new Date());C(m+q+f,{":":s,">":D},C.one[d]||function(b,B){h&&(h.spd=h.spd||+new Date()),console.STAT&&console.STAT(n,+new Date()-n,"put"),b||y[d]===j.s||(console.log(b="Disk count not same as ram count."),console.STAT&&console.STAT(+new Date(),j.s-y[d],"put ack != count")),delete y[d],b?a.on("in",{"@":d,err:b,DBG:h}):a.on("in",{"@":d,ok:B,DBG:h})},d,h&&(h.r=h.r||{})),h&&(h.sps=h.sps||+new Date())}});var y={};t.obj.empty,a.on("get",function(i){this.to.next(i);var d=(i._||"").DBG=i.DBG;d&&(d.sg=+new Date());var e,m,f,s,D=i["#"],h=i.get,j=i.get["#"],n=i.get["."]||"",b={};if("string"==typeof j?m=j:j&&(c!==(f=j["*"])&&(b.limit=s=1),c!==j[">"]&&(b.start=j[">"]),c!==j["<"]&&(b.end=j["<"]),m=s?""+f:f||j["="],s=null),m&&!b.limit&&("string"==typeof n?m=m+q+(b.atom=n):n&&(c!==n[">"]&&(b.start=n[">"],b.limit=1),c!==n["<"]&&(b.end=n["<"],b.limit=1),c!==(f=n["*"])&&(b.limit=s=1),m&&(m=m+q+(s?""+(f||""):f||(b.atom=n["="]||""))))),((f=h["%"])||b.limit)&&(b.limit=f<=(b.pack||100000)?f:1),(n["-"]||(j||{})["-"])&&(b.reverse=!0),(f=(a.next||"")[j])&&f.put){if(b.atom){if((f=(f.next||"")[b.atom])&&f.rad)return}else if(f&&f.rad)return}var B=t.state(),p=+new Date(),E=0;function M(o,k,z,F){if(E++,o){var u=(k=(m+k).split(q)).slice(0,1)[0];if(k=k.slice(-1)[0],b.limit&&b.limit<=b.count)return!0;var w,v,x=u,A=k;if("string"!=typeof o)return w=o[":"],v=o[">"],(e=e||{})[x]=t.state.ify(e[x],A,v,w,x),void(b.count=(b.count||0)+((w||"").length||9));b.count=(b.count||0)+o.length;var G=o.lastIndexOf(">"),S=l.decode(o.slice(G+1),null,q);o=l.decode(o.slice(0,G),null,q),(e=e||{})[u]=t.state.ify(e[u],k,S,o,u)}}d&&(d.sgm=p),C(m||"",function(o,k,z){d&&(d.sgr=+new Date()),d&&(d.sgi=z);try{g.store.stats.get.time[L%50]=+new Date()-p,++L,g.store.stats.get.count++,o&&(g.store.stats.get.err=o)}catch(G){}var F,u;if(console.STAT&&console.STAT(p,+new Date()-p,"got",JSON.stringify(m)),p=+new Date(),(z=z||"").unit&&k&&c!==(F=k[":"])&&c!==(u=k[">"])){var w=m.split(q),v=w[0],x=w[1];(e=e||{})[v]=t.state.ify(e[v],x,u,F,v),a.$.get(v).get(x)._.rad=B}else k&&("string"!=typeof k&&(b.atom?k=c:R.map(k,M)),!e&&k&&M(k,""),!b.atom&&!n&"string"==typeof j&&!b.limit&&!b.more&&(a.$.get(j)._.rad=B));d&&(d.sgp=+new Date()),console.STAT&&(r=+new Date()-p)>9&&(console.STAT(p,r,"got prep time"),console.STAT(p,E,"got prep #")),r,E=0,p=+new Date();var A=function(){};A.faith=!0,A.rad=h,a.on("in",{"@":D,put:e,"%":z.more?1:c,err:o||c,_:A,DBG:d}),console.STAT&&(r=+new Date()-p)>9&&console.STAT(p,r,"got emit",Object.keys(e||{}).length),e=c},b,d&&(d.r=d.r||{})),d&&(d.sgd=+new Date()),console.STAT&&(r=+new Date()-p)>9&&console.STAT(p,r,"get call")}),t.val.is,g.store.stats={get:{time:{},count:0},put:{time:{},count:0}};var L=0}});
